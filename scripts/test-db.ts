// ======================================================================
// üß™ –°–ö–†–ò–ü–¢ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –ë–î
// ======================================================================
//
// –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç.
// –ó–∞–ø—É—Å–∫: npx tsx scripts/test-db.ts
//
// –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:
// 1. –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
// 2. –°–æ–∑–¥–∞—ë—Ç —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
// 3. –°–æ–∑–¥–∞—ë—Ç —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä
// 4. –ß–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ
// 5. –£–¥–∞–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
// ======================================================================

import 'dotenv/config'; // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞
import { db, categories, products } from '../db';
import { eq } from 'drizzle-orm';

async function testConnection() {
  console.log('üîå –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL...\n');
  
  try {
    // =========================================
    // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    // =========================================
    console.log('1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
    
    // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    const result = await db.execute('SELECT NOW() as current_time');
    console.log(`   ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞: ${result.rows[0].current_time}\n`);
    
    // =========================================
    // 2. –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    // =========================================
    console.log('2Ô∏è‚É£ –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é...');
    
    const [newCategory] = await db.insert(categories).values({
      name: '–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è',
      description: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –ë–î',
    }).returning(); // returning() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—É—é –∑–∞–ø–∏—Å—å
    
    console.log(`   ‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞: ID=${newCategory.id}, Name="${newCategory.name}"\n`);
    
    // =========================================
    // 3. –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä
    // =========================================
    console.log('3Ô∏è‚É£ –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä...');
    
    const [newProduct] = await db.insert(products).values({
      name: '–¢–µ—Å—Ç–æ–≤—ã–π —Ç–æ–≤–∞—Ä',
      description: '–¢–æ–≤–∞—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö',
      price: '99.99', // –î–ª—è decimal –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫—É
      stock: 10,
      categoryId: newCategory.id, // –°–≤—è–∑—ã–≤–∞–µ–º —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
    }).returning();
    
    console.log(`   ‚úÖ –¢–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω: ID=${newProduct.id}, Name="${newProduct.name}", Price=${newProduct.price}‚ÇΩ\n`);
    
    // =========================================
    // 4. –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ
    // =========================================
    console.log('4Ô∏è‚É£ –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î...');
    
    const allProducts = await db.select().from(products);
    const allCategories = await db.select().from(categories);
    
    console.log(`   üì¶ –¢–æ–≤–∞—Ä–æ–≤ –≤ –ë–î: ${allProducts.length}`);
    console.log(`   üìÅ –ö–∞—Ç–µ–≥–æ—Ä–∏–π –≤ –ë–î: ${allCategories.length}\n`);
    
    // =========================================
    // 5. –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    // =========================================
    console.log('5Ô∏è‚É£ –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...');
    
    // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä (–æ–Ω —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é)
    await db.delete(products).where(eq(products.id, newProduct.id));
    console.log(`   üóëÔ∏è –¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω`);
    
    // –ó–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    await db.delete(categories).where(eq(categories.id, newCategory.id));
    console.log(`   üóëÔ∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞\n`);
    
    // =========================================
    // ‚úÖ –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!
    // =========================================
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´! –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç!');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    
    console.log('üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:');
    console.log('   npm run db:generate - —Å–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏');
    console.log('   npm run db:migrate  - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏');
    console.log('   npm run db:studio   - –æ—Ç–∫—Ä—ã—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –ë–î');
    
  } catch (error) {
    console.error('\n‚ùå –û–®–ò–ë–ö–ê:', error);
    console.log('\nüîç –ü—Ä–æ–≤–µ—Ä—å:');
    console.log('   1. –ó–∞–ø—É—â–µ–Ω –ª–∏ Docker: docker-compose up -d');
    console.log('   2. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ DATABASE_URL –≤ —Ñ–∞–π–ª–µ .env');
    console.log('   3. –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏: npm run db:migrate');
    process.exit(1);
  } finally {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
    process.exit(0);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
testConnection();

